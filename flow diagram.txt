┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                       │
│                                                  FLASH SALE SYSTEM FLOW                                               │
│                                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐       ┌─────────────────────┐       ┌─────────────────────┐        ┌─────────────────────┐
│                     │       │                     │       │                     │        │                     │
│    INITIALIZATION   │──────▶│   MANAGE SALES      │──────▶│   HTTP SERVER      │──────▶│    CHECKOUT HANDLER  │
│                     │       │   (goroutine)       │       │   (:8080)           │        │   (/checkout)       │
└─────────────────────┘       └─────────────────────┘       └─────────────────────┘        └─────────────────────┘
        │                                                                                         │
        │                                                                                         │
        ▼                                                                                         ▼
┌─────────────────────┐       ┌─────────────────────┐                               ┌─────────────────────┐
│                     │       │                     │                               │                     │
│  Redis Connection   │       │  Postgres Connection│                               │  PURCHASE HANDLER   │
│  (redis.NewClient)  │       │  (sql.Open)         │                               │  (/purchase)        │
│                     │       │                     │                               │                     │
└─────────────────────┘       └─────────────────────┘                               └─────────────────────┘
                                                                                              ▲
                                                                                              │
                                                                                              ▼
                                                                                    ┌─────────────────────┐
                                                                                    │                     │
                                                                                    │   ITEM GENERATION   │
                                                                                    │   (generateItem)    │
                                                                                    │                     │
                                                                                    └─────────────────────┘


┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                       │
│                                              DETAILED CHECKOUT FLOW (/checkout)                                       │
│                                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│               │    │               │    │               │    │               │    │               │    │               │
│  Validate     │───▶│  Check Sale  │───▶│  Check User   │───▶│ Generate     │───▶│ Store in      │───▶│ Return       │
│  Request      │    │  Availability │    │  Limits       │    │ Unique Code   │    │ Redis+Postgres│    │ Checkout Code │
│  (user_id,id) │    │  (Redis)      │    │  (Redis)      │    │ (UUID)        │    │               │    │ (JSON)        │
│               │    │               │    │               │    │               │    │               │    │               │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘


┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                       │
│                                             DETAILED PURCHASE FLOW (/purchase)                                        │
│                                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│               │    │               │    │               │    │               │    │               │    │               │
│  Validate     │───▶│  Verify Code  │───▶│  Check Code  │───▶│  Begin DB     │───▶│  Update      │───▶│  Return      │
│  Request      │    │  in Redis     │    │  Usage Status │    │  Transaction  │    │  Counters     │    │  Purchase     │
│  (code)       │    │               │    │  (Postgres)   │    │               │    │  (Redis+PG)   │    │  Response     │
│               │    │               │    │               │    │               │    │               │    │  (JSON)       │
└───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘    └───────────────┘
                                                                       │
                                                                       │
                                                                       ▼
                                                             ┌─────────────────┐
                                                             │                 │
                                                             │  Generate Item  │
                                                             │  Details        │
                                                             │                 │
                                                             └─────────────────┘


┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                       │
│                                              DATA STORAGE INTERACTIONS                                                │
│                                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐                               ┌─────────────────────┐
│                     │                               │                     │
│       REDIS         │                               │     POSTGRESQL      │
│                     │                               │                     │
├─────────────────────┤                               ├─────────────────────┤
│ - sale:{id}:total   │                               │ - sales             │
│ - code:{code}       │                               │ - checkout_attempts │
│ - sale:{id}:user:   │                               │ - purchases         │
│   {user}:purchases  │                               │                     │
│ - sale:{id}:user:   │                               │                     │
│   {user}:checkouts  │                               │                     │
└─────────────────────┘                               └─────────────────────┘
        ▲                                                     ▲
        │                                                     │
        │                                                     │
        │                                                     │
        │                                                     │
        ▼                                                     ▼
┌─────────────────────┐       ┌─────────────────────┐       ┌─────────────────────┐
│                     │       │                     │       │                     │
│   CHECKOUT HANDLER  │──────▶│   PURCHASE HANDLER │──────▶│  MANAGE SALES       │
│                     │       │                     │       │  (hourly job)       │
└─────────────────────┘       └─────────────────────┘       └─────────────────────┘


┌───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                                       │
│                                              CONCURRENCY CONTROL                                                      │
│                                                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐
│                     │
│    saleMutex        │
│  (sync.Mutex)       │
│                     │
└─────────────────────┘
        ▲
        │
        │
        ▼
┌─────────────────────┐       ┌─────────────────────┐
│                     │       │                     │
│  initializeSale()   │       │  checkoutHandler()  │
│                     │       │                     │
└─────────────────────┘       └─────────────────────┘
                                      │
                                      │
                                      ▼
                            ┌─────────────────────┐
                            │                     │
                            │  purchaseHandler()  │
                            │                     │
                            └─────────────────────┘